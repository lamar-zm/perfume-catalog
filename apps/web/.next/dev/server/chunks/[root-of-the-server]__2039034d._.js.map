{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///Users/lamarkhalifa/projects/perfume-catalog/apps/web/src/app/api/upload/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { writeFile, mkdir, unlink } from 'fs/promises';\nimport { existsSync } from 'fs';\nimport path from 'path';\nimport type { ApiResponse } from '@perfume-catalog/shared';\n\n// Create uploads directory if it doesn't exist\nconst uploadDir = path.join(process.cwd(), 'public', 'uploads');\n\nasync function ensureUploadDir() {\n  if (!existsSync(uploadDir)) {\n    await mkdir(uploadDir, { recursive: true });\n  }\n}\n\n// Simple image compression by reducing quality\nasync function compressImage(buffer: Buffer, mimeType: string): Promise<Buffer> {\n  // For now, return the original buffer\n  // In production, you could use sharp:\n  // const sharp = (await import('sharp')).default;\n  // return sharp(buffer).resize(800, 800, { fit: 'inside', withoutEnlargement: true }).jpeg({ quality: 80 }).toBuffer();\n  return buffer;\n}\n\n// POST /api/upload - Upload an image\nexport async function POST(request: NextRequest) {\n  try {\n    await ensureUploadDir();\n\n    const formData = await request.formData();\n    const file = formData.get('file') as File | null;\n\n    if (!file) {\n      return NextResponse.json<ApiResponse<never>>(\n        { success: false, error: 'لم يتم اختيار ملف' },\n        { status: 400 }\n      );\n    }\n\n    // Validate file type\n    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];\n    if (!validTypes.includes(file.type)) {\n      return NextResponse.json<ApiResponse<never>>(\n        { success: false, error: 'نوع الملف غير مدعوم. يرجى استخدام JPEG, PNG, WebP, أو GIF' },\n        { status: 400 }\n      );\n    }\n\n    // Validate file size (max 10MB)\n    const maxSize = 10 * 1024 * 1024; // 10MB\n    if (file.size > maxSize) {\n      return NextResponse.json<ApiResponse<never>>(\n        { success: false, error: 'حجم الملف كبير جداً. الحد الأقصى 10 ميجابايت' },\n        { status: 400 }\n      );\n    }\n\n    // Read file buffer\n    const bytes = await file.arrayBuffer();\n    const buffer = Buffer.from(bytes);\n\n    // Compress image\n    const compressedBuffer = await compressImage(buffer, file.type);\n\n    // Generate unique filename\n    const timestamp = Date.now();\n    const randomStr = Math.random().toString(36).substring(2, 8);\n    const extension = file.name.split('.').pop() || 'jpg';\n    const filename = `${timestamp}-${randomStr}.${extension}`;\n\n    // Save file\n    const filePath = path.join(uploadDir, filename);\n    await writeFile(filePath, compressedBuffer);\n\n    // Return URL\n    const url = `/uploads/${filename}`;\n\n    return NextResponse.json<ApiResponse<{ url: string; filename: string }>>({\n      success: true,\n      data: { url, filename },\n      message: 'تم رفع الصورة بنجاح',\n    });\n  } catch (error) {\n    console.error('Error uploading file:', error);\n    return NextResponse.json<ApiResponse<never>>(\n      { success: false, error: 'فشل رفع الملف' },\n      { status: 500 }\n    );\n  }\n}\n\n// DELETE /api/upload - Delete an image\nexport async function DELETE(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const { filename } = body;\n\n    if (!filename) {\n      return NextResponse.json<ApiResponse<never>>(\n        { success: false, error: 'اسم الملف مطلوب' },\n        { status: 400 }\n      );\n    }\n\n    // Security: only allow deleting files from uploads directory\n    const safeFilename = path.basename(filename);\n    const filePath = path.join(uploadDir, safeFilename);\n\n    // Check if file exists\n    if (!existsSync(filePath)) {\n      return NextResponse.json<ApiResponse<never>>(\n        { success: false, error: 'الملف غير موجود' },\n        { status: 404 }\n      );\n    }\n\n    // Delete file\n    await unlink(filePath);\n\n    return NextResponse.json<ApiResponse<{ filename: string }>>({\n      success: true,\n      data: { filename: safeFilename },\n      message: 'تم حذف الملف بنجاح',\n    });\n  } catch (error) {\n    console.error('Error deleting file:', error);\n    return NextResponse.json<ApiResponse<never>>(\n      { success: false, error: 'فشل حذف الملف' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}